name: Build and Push Docker Images

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */8 * * *"

jobs:
  bake:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target: [base]
        cuda: [12-8]
    steps:
      - name: Maximize build space
        uses: AdityaGarg8/remove-unwanted-software@v5
        with:
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'
          remove-large-packages: 'true'
          remove-cached-tools: 'true'
          remove-swapfile: 'true'

      - name: Stop Docker and move data directory to /mnt
        run: |
          echo "==> Stopping Docker service"
          sudo systemctl stop docker
          sudo systemctl stop docker.socket
          
          echo "==> Creating new Docker data directory in /mnt"
          sudo mkdir -p /mnt/docker-data
          
          echo "==> Moving existing Docker data (if any)"
          if [ -d "/var/lib/docker" ]; then
            sudo mv /var/lib/docker/* /mnt/docker-data/ 2>/dev/null || true
          fi
          
          echo "==> Configuring Docker daemon to use /mnt/docker-data"
          sudo mkdir -p /etc/docker
          sudo tee /etc/docker/daemon.json > /dev/null <<EOF
          {
            "data-root": "/mnt/docker-data",
            "storage-driver": "overlay2"
          }
          EOF
          
          echo "==> Starting Docker service"
          sudo systemctl start docker
          
          echo "==> Verifying new configuration"
          docker info | grep "Docker Root Dir"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/bake-action@v6
        with:
          targets: ${{ matrix.target }}-${{ matrix.cuda }}
          push: true
